# Telnyx Media Streaming Diagnostic Plan

## Problem Statement

The Telnyx Call Control Connection is answering calls successfully, but no audio is being heard by the caller. The media stream is not starting properly despite the `streaming_start` API call returning HTTP 200 OK.

## Evidence

### ✅ Working Components
- Call initiated webhook received
- Call answered webhook received
- Websocket connection established
- Websocket receives `{"event":"connected","version":"1.0.0"}`
- `streaming_start` API call returns HTTP 200 OK
- Audio is being generated by Cartesia TTS
- Audio frames are being sent via websocket (OutputAudioRawFrame)

### ❌ Missing Components
- NO `streaming.started` webhook received
- NO `start` event on websocket with `media_format` details
- NO audio heard by caller

## Root Cause Hypothesis

According to Telnyx documentation, the expected flow is:

1. Websocket connects → receives `{"event":"connected"}` ✅
2. `streaming_start` API called → returns 200 ✅
3. **`streaming.started` webhook sent** ❌ NOT HAPPENING
4. **`start` event on websocket with media_format** ❌ NOT HAPPENING
5. Media events flow on websocket

**Hypothesis**: The `streaming_start` API call is being rejected silently, or the parameters are incorrect, preventing Telnyx from actually starting the stream.

## Diagnostic Steps

### Step 1: Verify streaming_start Request/Response
**Status**: Logging added, awaiting test call

**What to check**:
- Exact payload sent to `streaming_start`
- Full response body from Telnyx (not just status code)
- Any error messages in response

**Expected in logs**:
```
INFO:src.api.telnyx_webhook:Sending stream_start to Telnyx: {payload details}
INFO:src.api.telnyx_webhook:Telnyx stream_start response: 200 {response body}
```

### Step 2: Verify streaming.started Webhook
**Status**: Handler added, awaiting test call

**What to check**:
- Whether `streaming.started` webhook is received
- Full webhook payload

**Expected in logs**:
```
INFO:src.api.telnyx_webhook:Received Telnyx webhook: event_type=streaming.started
INFO:src.api.telnyx_webhook:Streaming started: {event_data}
```

### Step 3: Verify Websocket start Event
**Status**: Already logging, awaiting test call

**What to check**:
- Whether `{"event":"start"}` is received on websocket
- The `media_format` section with encoding and sample_rate

**Expected in logs**:
```
INFO:src.bot_runner:Telnyx WS raw message: {"event":"start","sequence_number":"1","start":{...,"media_format":{"encoding":"G722","sample_rate":16000,"channels":1}},...}
```

## Known Issues & Potential Fixes

### Issue 1: G722 Codec Parameters
**Research**: Telnyx supports G722 as of September 2025 update
**Current config**:
```python
{
    "stream_codec": "G722",
    "stream_bidirectional_mode": "rtp",
    "stream_bidirectional_codec": "G722",
    "stream_bidirectional_sampling_rate": 16000,
}
```

**Potential issues**:
- Missing `stream_bidirectional_target_legs` parameter
- Incorrect `stream_bidirectional_mode` for G722

**Test**: Add all optional parameters explicitly

### Issue 2: Timing Race Condition
**Observation**: Websocket connects before `streaming_start` completes
**Current flow**:
1. `call.answered` webhook received
2. Websocket connects immediately
3. `streaming_start` API called asynchronously

**Potential issue**: Telnyx might reject the stream if websocket connects too early

**Test**: Add delay or ensure `streaming_start` completes before websocket connects

### Issue 3: Stream URL Format
**Current**: `wss://{ngrok_domain}/ws/media-stream/{call_control_id}`
**Telnyx expects**: WebSocket URL that it can connect to

**Potential issue**: URL encoding or format

**Test**: Verify URL is accessible and properly formatted

## Test Procedure

1. **Restart server** (if code changes were made)
2. **Send warmup request**: `curl http://127.0.0.1:8000/health`
3. **Make test call** to `+61 2 4067 5354`
4. **Observe logs** for:
   - `stream_start` request payload
   - `stream_start` response body
   - `streaming.started` webhook
   - Websocket `start` event with `media_format`
5. **Analyze results** and identify root cause

## Next Steps Based on Results

### If streaming.started webhook is NOT received:
→ The `streaming_start` API call is being rejected
→ Check response body for error details
→ Verify parameters against Telnyx API spec
→ Try fallback to PCMU 8kHz to isolate codec issue

### If streaming.started webhook IS received but no start event:
→ Websocket connection issue
→ Check if Telnyx can reach our websocket URL
→ Verify websocket stays open
→ Check for websocket errors

### If start event IS received but wrong codec:
→ Telnyx accepted the request but used different codec
→ Check `media_format.encoding` in start event
→ Adjust our pipeline to match

## Current Configuration

### Telnyx Parameters
```python
stream_url = f"wss://{NGROK_URL}/ws/media-stream/{call_control_id}"
payload = {
    "stream_url": stream_url,
    "stream_track": "both_tracks",
    "stream_codec": "G722",
    "stream_bidirectional_mode": "rtp",
    "stream_bidirectional_codec": "G722",
    "stream_bidirectional_sampling_rate": 16000,
}
```

### Pipeline Configuration
```python
TelnyxFrameSerializer.InputParams(
    telnyx_sample_rate=16000,
    sample_rate=16000,
    inbound_encoding="G722",
    outbound_encoding="G722",
)

StartFrame(
    audio_in_sample_rate=16000,
    audio_out_sample_rate=16000,
)
```

## References

- [Telnyx Media Streaming Docs](https://developers.telnyx.com/docs/voice/programmable-voice/media-streaming)
- [Telnyx streaming_start API](https://developers.telnyx.com/api-reference/call-commands/streaming-start)
- [Telnyx Codec Support](https://telnyx.com/release-notes/media-streaming-codec-update)
- [Pipecat Telnyx Example](https://github.com/pipecat-ai/pipecat/tree/main/examples/telnyx-chatbot)

## Status

**Current Status**: Awaiting test call with enhanced logging
**Last Updated**: 2026-02-09 19:03 UTC
**Next Action**: Make test call and analyze logs
